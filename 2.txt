locals {

diag_settings_iterator = local.site_type == "primary" ? {
  for v in flatten([
    for type_key, type_name in local.diag_logging_resource_types : [
      for resource_value in data.azurerm_resources.diag[type_key].resources : {
        type_key         = type_key
        resource_name    = resource_value.name
        resource_id      = resource_value.id

        region_short_name = length([
          for r in local.regions :
          r.name_short if resource_value.location == lower(replace(r.name, " ", ""))
        ]) == 0
          ? local.regions.primary.name_short
          : [
              for r in local.regions :
              r.name_short if resource_value.location == lower(replace(r.name, " ", ""))
            ][0]

        region_mismatch = length([
          for r in local.regions :
          r.name_short if resource_value.location == lower(replace(r.name, " ", ""))
        ]) == 0

        logs_loga_targets = [
          for k, v in data.azurerm_monitor_diagnostic_categories.env[type_key].logs : v
          if contains(
            lookup(
              merge(
                lookup(local.diag_logging_loga_targets, type_key, {}),
                lookup(
                  lookup(
                    lookup(local.diag_logging_loga_targets, type_key, {}),
                    "per_resource",
                    {}
                  ),
                  resource_value.name,
                  {}
                )
              ),
              "logs",
              []
            ),
            k
          )
          || contains(
            lookup(
              merge(
                lookup(local.diag_logging_loga_targets, type_key, {}),
                lookup(
                  lookup(
                    lookup(local.diag_logging_loga_targets, type_key, {}),
                    "per_resource",
                    {}
                  ),
                  resource_value.name,
                  {}
                )
              ),
              "logs",
              []
            ),
            "*"
          )
          || length([
            for r in local.regions :
            r.name_short if resource_value.location == lower(replace(r.name, " ", ""))
          ]) == 0
        ]

        metrics_loga_targets = [
          for k, v in data.azurerm_monitor_diagnostic_categories.env[type_key].metrics : v
          if contains(
            lookup(
              merge(
                lookup(local.diag_logging_loga_targets, type_key, {}),
                lookup(
                  lookup(
                    lookup(local.diag_logging_loga_targets, type_key, {}),
                    "per_resource",
                    {}
                  ),
                  resource_value.name,
                  {}
                )
              ),
              "metrics",
              []
            ),
            k
          )
          || contains(
            lookup(
              merge(
                lookup(local.diag_logging_loga_targets, type_key, {}),
                lookup(
                  lookup(
                    lookup(local.diag_logging_loga_targets, type_key, {}),
                    "per_resource",
                    {}
                  ),
                  resource_value.name,
                  {}
                )
              ),
              "metrics",
              []
            ),
            "*"
          )
          || length([
            for r in local.regions :
            r.name_short if resource_value.location == lower(replace(r.name, " ", ""))
          ]) == 0
        ]

        logs_evh_targets = [
          for k, v in data.azurerm_monitor_diagnostic_categories.env[type_key].logs : v
          if !contains(
            lookup(
              merge(
                lookup(local.diag_logging_loga_targets, type_key, {}),
                lookup(
                  lookup(
                    lookup(local.diag_logging_loga_targets, type_key, {}),
                    "per_resource",
                    {}
                  ),
                  resource_value.name,
                  {}
                )
              ),
              "logs",
              []
            ),
            k
          )
          && !contains(
            lookup(
              merge(
                lookup(local.diag_logging_loga_targets, type_key, {}),
                lookup(
                  lookup(
                    lookup(local.diag_logging_loga_targets, type_key, {}),
                    "per_resource",
                    {}
                  ),
                  resource_value.name,
                  {}
                )
              ),
              "logs",
              []
            ),
            "*"
          )
          && length([
            for r in local.regions :
            r.name_short if resource_value.location == lower(replace(r.name, " ", ""))
          ]) != 0
        ]

        metrics_evh_targets = [
          for k, v in data.azurerm_monitor_diagnostic_categories.env[type_key].metrics : v
          if !contains(
            lookup(
              merge(
                lookup(local.diag_logging_loga_targets, type_key, {}),
                lookup(
                  lookup(
                    lookup(local.diag_logging_loga_targets, type_key, {}),
                    "per_resource",
                    {}
                  ),
                  resource_value.name,
                  {}
                )
              ),
              "metrics",
              []
            ),
            k
          )
          && !contains(
            lookup(
              merge(
                lookup(local.diag_logging_loga_targets, type_key, {}),
                lookup(
                  lookup(
                    lookup(local.diag_logging_loga_targets, type_key, {}),
                    "per_resource",
                    {}
                  ),
                  resource_value.name,
                  {}
                )
              ),
              "metrics",
              []
            ),
            "*"
          )
          && length([
            for r in local.regions :
            r.name_short if resource_value.location == lower(replace(r.name, " ", ""))
          ]) != 0
        ]
      }
      if !contains(
        lookup(local.my_env, "diag_logging_excluded_resource_groups", []),
        resource_value.resource_group_name
      )
    ]
  ]) :
  lower(replace(v.resource_id, "/", "_")) => v
  if length(regexall("/databases/master", v.resource_id)) == 0
} : {}

}
